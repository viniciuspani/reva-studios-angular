<div class="user-dashboard">
  <app-navbar></app-navbar>
  <p-toast></p-toast>

  <!-- Modal de Criar Pasta -->
  <p-dialog
    [(visible)]="showCreateDialog"
    [header]="parentFolderForCreate() ? languageService.t('userDashboard.createSubfolder') : languageService.t('userDashboard.createFolder')"
    [modal]="true"
    [style]="{width: '450px'}"
    [draggable]="false"
    [resizable]="false"
    (onHide)="closeCreateDialog()">

    <div class="edit-dialog-content">
      <label for="createFolderName" class="edit-label">
        {{ parentFolderForCreate() ? languageService.t('userDashboard.subfolderIn') + ' "' + parentFolderForCreate()!.name + '"' : languageService.t('userDashboard.folderName') }}
      </label>
      <input
        id="createFolderName"
        type="text"
        pInputText
        [(ngModel)]="createFolderName"
        (keyup.enter)="saveCreateFolder()"
        (keyup.escape)="closeCreateDialog()"
        class="edit-input"
        [placeholder]="languageService.t('userDashboard.folderNamePlaceholder')"
        autofocus />
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button
          [label]="languageService.t('userDashboard.cancel')"
          icon="pi pi-times"
          (onClick)="closeCreateDialog()"
          styleClass="p-button-text p-button-secondary">
        </p-button>
        <p-button
          [label]="languageService.t('userDashboard.create')"
          icon="pi pi-plus"
          (onClick)="saveCreateFolder()"
          styleClass="p-button-primary">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Modal de Edição de Pasta -->
  <p-dialog
    [(visible)]="showEditDialog"
    [header]="languageService.t('userDashboard.editFolder')"
    [modal]="true"
    [style]="{width: '450px'}"
    [draggable]="false"
    [resizable]="false"
    (onHide)="closeEditDialog()">

    <div class="edit-dialog-content">
      <label for="folderName" class="edit-label">{{ languageService.t('userDashboard.folderName') }}</label>
      <input
        id="folderName"
        type="text"
        pInputText
        [(ngModel)]="newFolderName"
        (keyup.enter)="saveEditFolder()"
        (keyup.escape)="closeEditDialog()"
        class="edit-input"
        [placeholder]="languageService.t('userDashboard.folderNamePlaceholder')"
        autofocus />
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button
          [label]="languageService.t('userDashboard.cancel')"
          icon="pi pi-times"
          (onClick)="closeEditDialog()"
          styleClass="p-button-text p-button-secondary">
        </p-button>
        <p-button
          [label]="languageService.t('userDashboard.save')"
          icon="pi pi-check"
          (onClick)="saveEditFolder()"
          styleClass="p-button-primary">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Modal de Deletar Pasta -->
  <p-dialog
    [(visible)]="showDeleteDialog"
    [header]="languageService.t('userDashboard.deleteFolder')"
    [modal]="true"
    [style]="{width: '450px'}"
    [draggable]="false"
    [resizable]="false"
    (onHide)="closeDeleteDialog()">

    <div class="delete-dialog-content">
      <div class="delete-warning-icon">
        <i class="pi pi-exclamation-triangle"></i>
      </div>
      <h3>{{ languageService.t('userDashboard.deleteConfirmTitle') }}</h3>
      <p class="delete-folder-name">{{ folderToDelete()?.name }}</p>
      <p class="delete-warning-text">
        {{ languageService.t('userDashboard.deleteWarning') }}
      </p>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button
          [label]="languageService.t('userDashboard.cancel')"
          icon="pi pi-times"
          (onClick)="closeDeleteDialog()"
          styleClass="p-button-text p-button-secondary">
        </p-button>
        <p-button
          [label]="languageService.t('userDashboard.delete')"
          icon="pi pi-trash"
          (onClick)="confirmDeleteFolder()"
          styleClass="p-button-danger">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
      <h1>{{ languageService.t('userDashboard.title') }} {{ currentUser()?.name }}</h1>
      <p>{{ languageService.t('userDashboard.welcome') }}</p>
    </div>

    <!-- Cards de estatísticas -->
    <div class="stats-grid">
      <p-card>
        <ng-template pTemplate="header">
          <div class="card-icon">
            <i class="pi pi-briefcase"></i>
          </div>
        </ng-template>
        <h3>{{ languageService.t('userDashboard.currentPlan') }}</h3>
        <p class="card-description">{{ languageService.t('userDashboard.currentPlanDesc') }}</p>
        <div class="stat-value capitalize">{{ currentUser()?.plan }}</div>
        <p class="stat-detail">{{ getStorageLimitFormatted() }}</p>
      </p-card>

      <p-card>
        <ng-template pTemplate="header">
          <div class="card-icon">
            <i class="pi pi-database"></i>
          </div>
        </ng-template>
        <h3>{{ languageService.t('userDashboard.spaceUsed') }}</h3>
        <p class="card-description">{{ languageService.t('userDashboard.spaceUsedDesc') }}</p>
        <div class="stat-value">{{ formatBytes(currentUser()?.storageUsed || 0) }}</div>
        <p-progressBar *ngIf="currentUser()?.plan !== 'studio'" [value]="getStoragePercentage()" [showValue]="false"
          styleClass="storage-bar">
        </p-progressBar>
        <p class="stat-detail" *ngIf="currentUser()?.plan !== 'studio'">
          {{ getStoragePercentage().toFixed(1) }}% {{ languageService.t('userDashboard.used') }}
        </p>
      </p-card>

      <p-card>
        <ng-template pTemplate="header">
          <div class="card-icon">
            <i class="pi pi-images"></i>
          </div>
        </ng-template>
        <h3>{{ languageService.t('userDashboard.totalPhotos') }}</h3>
        <p class="card-description">{{ languageService.t('userDashboard.totalPhotosDesc') }}</p>
        <div class="stat-value">{{ getTotalPhotos() }}</div>
        <p class="stat-detail">
          {{ getTotalPhotos() === 1 ? languageService.t('userDashboard.photo') : languageService.t('userDashboard.photos') }} {{ languageService.t('userDashboard.stored') }}
        </p>
      </p-card>
    </div>

    <!-- Grid principal com sidebar e galeria -->
    <div class="main-grid">
      <!-- Sidebar de pastas -->
      <p-card class="folders-card">
        <ng-template pTemplate="header">
          <div class="folders-header">
            <h3>{{ languageService.t('userDashboard.folders') }}</h3>
            <p-button icon="pi pi-plus" [rounded]="true" [text]="true" size="small" (onClick)="createFolder()"
              [pTooltip]="languageService.t('userDashboard.newFolder')" styleClass="add-folder-btn">
            </p-button>
          </div>
        </ng-template>

        <!-- CUSTOM TREE COMPONENT -->
        <app-custom-tree
          [nodes]="getRootTreeNodes()"
          (nodeSelect)="onFolderSelect($event)"
          (createSubfolder)="createSubfolder($event)"
          (editFolder)="editFolder($event)"
          (deleteFolder)="deleteFolder($event)">
        </app-custom-tree>
      </p-card>

      <!-- Área principal -->
      <div class="gallery-section">
        <!-- Card de Upload -->
        <div class="upload-card">
          <p-card>
            <ng-template pTemplate="header">
              <div class="upload-header">
                <div>
                  <h3>
                    <i class="pi pi-upload" style="color:#7c3aed; margin-right:.4rem;"></i>
                    {{ languageService.t('userDashboard.uploadPhotos') }}
                  </h3>
                  <p>{{ selectedFolderId() ? languageService.t('userDashboard.uploadTo') + ' ' + getCurrentFolderName() : languageService.t('userDashboard.uploadDesc') }}</p>
                </div>
              </div>
            </ng-template>

            <input #fileInput type="file" accept="image/*" multiple (change)="onFileSelect($event)"
              style="display: none">

            <p-button [label]="languageService.t('userDashboard.selectPhotos')" icon="pi pi-upload" [loading]="isUploading()"
              (onClick)="openFileSelector()">
            </p-button>

            <!-- Info do arquivo selecionado -->
            <div *ngIf="selectedFile()" class="file-path-info">
              <p-card styleClass="bg-gray-50">
                <ng-template pTemplate="header">
                  <div class="file-info-header">
                    <i class="pi pi-folder-open"></i>
                    <h4>{{ languageService.t('userDashboard.fileInfo') }}</h4>
                  </div>
                </ng-template>

                <div class="path-details">
                  <div class="path-item">
                    <label>{{ languageService.t('userDashboard.localFile') }}</label>
                    <p>{{ selectedFile()!.path }}</p>
                  </div>
                  <div class="path-item">
                    <label>{{ languageService.t('userDashboard.s3Path') }}</label>
                    <p>s3://reva-studios-uploads/{{ selectedFile()!.name }}</p>
                  </div>
                </div>
              </p-card>
            </div>
          </p-card>
        </div>

        <!-- Galeria de Fotos -->
        <div class="gallery-card">
          <p-card>
            <ng-template pTemplate="header">
              <div class="gallery-header">
                <h3>
                  <i class="pi pi-folder-open"></i>
                  {{ getCurrentFolderName() }}
                </h3>
                <p>{{ photos().length }} {{ photos().length === 1 ? languageService.t('userDashboard.photo') : languageService.t('userDashboard.photos') }} {{ languageService.t('userDashboard.photosInFolder') }}</p>
              </div>
            </ng-template>

            <!-- Loading state -->
            <div *ngIf="isLoadingPhotos()" class="loading-photos">
              <i class="pi pi-spin pi-spinner" style="font-size: 2rem; color: #7c3aed;"></i>
              <p>{{ languageService.t('userDashboard.loading') }}</p>
            </div>

            <!-- Grid de fotos -->
            <div *ngIf="!isLoadingPhotos() && photos().length > 0; else noPhotos" class="photos-grid">
              <div *ngFor="let photo of photos()" class="photo-card">
                <!-- Loading individual da imagem -->
                <div *ngIf="photo.isLoadingUrl" class="photo-loading">
                  <i class="pi pi-spin pi-spinner"></i>
                  <span>{{ languageService.t('userDashboard.loading') }}</span>
                </div>

                <!-- Imagem ou placeholder -->
                <img
                  *ngIf="!photo.isLoadingUrl && photo.displayUrl"
                  [src]="photo.displayUrl"
                  [alt]="photo.name"
                  (error)="onImageError($event, photo)">

                <!-- Erro ao carregar imagem -->
                <div *ngIf="!photo.isLoadingUrl && !photo.displayUrl" class="photo-error">
                  <i class="pi pi-exclamation-triangle"></i>
                  <span>{{ languageService.t('userDashboard.loadingError') }}</span>
                </div>

                <!-- Overlay com ações (só aparece se a imagem estiver carregada) -->
                <div *ngIf="!photo.isLoadingUrl && photo.displayUrl" class="photo-overlay">
                  <!-- Download -->
                  <p-button icon="pi pi-download" [rounded]="true" size="small"
                    (onClick)="downloadPhoto(photo)" styleClass="btn-download"
                    [pTooltip]="languageService.t('userDashboard.download')" tooltipPosition="top">
                  </p-button>
                  <!-- Mover -->
                  <p-button icon="pi pi-arrows-alt" [rounded]="true" size="small"
                    (onClick)="moveMenu.toggle($event)" styleClass="btn-move"
                    [pTooltip]="languageService.t('userDashboard.moveToFolder')" tooltipPosition="top">
                  </p-button>
                  <p-menu #moveMenu [model]="getMoveMenuItems(photo)" [popup]="true" appendTo="body">
                  </p-menu>
                  <!-- Deletar -->
                  <p-button icon="pi pi-trash" [rounded]="true" size="small"
                    (onClick)="deletePhoto(photo)" styleClass="btn-delete"
                    [pTooltip]="languageService.t('userDashboard.delete')" tooltipPosition="top">
                  </p-button>
                </div>

                <div class="photo-name">{{ photo.name }}</div>
              </div>
            </div>

            <ng-template #noPhotos>
              <div class="no-photos">
                <i class="pi pi-images"></i>
                <p>
                  {{ selectedFolderId()
                  ? languageService.t('userDashboard.noPhotos')
                  : languageService.t('userDashboard.noPhotosYet') }}
                </p>
              </div>
            </ng-template>
          </p-card>
        </div>
      </div>
    </div>
  </div>
</div>